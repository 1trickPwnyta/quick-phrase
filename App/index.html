<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0" />
		
		<!-- Style for dialog boxes -->
		<link href="style/dialog.css" rel="stylesheet" />
		
		<!-- Main style -->
		<link href="style/main.css" type="text/css" rel="stylesheet" />
		
		<!-- Theme style -->
		<link href="style/theme_light.css" type="text/css" rel="stylesheet" />
		
		<!-- Phonegap specific functions -->
		<script type="text/javascript" src="phonegap.js"></script>
		
		<!-- AJAX functions -->
		<script src="scripts/ajax.js"></script>
		
		<!-- Dialog box functions -->
		<script src="scripts/dialog.js"></script>
		
		<!-- Main JavaScript files -->
		<script src="scripts/definitions.js"></script>
		<script src="scripts/config.js"></script>
		<script src="scripts/settings.js"></script>
		<script src="scripts/strings.js"></script>
		<script src="scripts/helper.js"></script>
		<script src="scripts/userInterface.js"></script>
		<script src="scripts/menu.js"></script>
		<script src="scripts/customPhrases.js"></script>
		<script src="scripts/webService.js"></script>
		<script src="scripts/database.js"></script>
		<script src="scripts/starterPhrases.js"></script>
		<script src="scripts/main.js"></script>
		
		<script>
			var tags = new Array();								// Holds the currently loaded phrases
			var usedTags = new Array();							// Holds the phrases that have been used in the current round
			var usedTagsOverall = new Array();					// Holds the phrases that have been used the whole time the app was open
			var loadingTags = false;							// Whether new phrases are currently loading
			var stats;											// Object that holds new phrase creation stats
			var pointGiven = true;								// Whether a point has been given for the last round yet
		
			window.onload = function() {
				if (PHONEGAP) {
					// Set the deviceready callback
					document.addEventListener("deviceready", onDeviceReady, false);
				} else
					// Just call the deviceready callback directly
					onDeviceReady();
			};
			
			function onDeviceReady() {
				// Hide the splash screen and load the main screen after one second
				window.setTimeout(function() {
					document.getElementById("splashscreen").className = "hidden";
				}, 1000);
				
				// Add long-click to about button in the menu to turn on developer mode
				var aboutItem = document.getElementById("menuItemAbout");
				aboutItem.onmouseup = function() {
					// Cancel the long press
					window.clearTimeout(pressTimer)
					return false;
				};
				(function(aboutItem) {
					aboutItem.onmousedown = function() {
						// Wait for a long press
						pressTimer = window.setTimeout(function() {
							menuItemAboutLongClick();
						}, 1000);
						return false; 
					};
				})(aboutItem);
				
				if (PHONEGAP) {
					// Set the Android back button action
					document.addEventListener("backbutton", backButtonClick, false);
					
					// Hide the edgy option in the Google Play edition
					if (APP_GOOGLEPLAY_EDITION) {
						var menuItemEdgy = document.getElementById("menuItemEdgy");
						menuItemEdgy.parentNode.removeChild(menuItemEdgy);
					}
					
					// Workaround for lack of CSS "vw" support in Android 4.3-
					if (parseFloat(device.version) < 4.39) {
						var viewport = function() {
							var e = window, a = 'inner';
							if (!('innerWidth' in window )) {
								a = 'client';
								e = document.documentElement || document.body;
							}
							return { width : e[ a+'Width' ] , height : e[ a+'Height' ] };
						}
						var vw = (viewport().width/100);
						document.body.style.fontSize = vw*5 + 'px';
					}
				}
				
				initializeLocalDatabase();
				
				// Load all the game data
				showLoadingScreen();
				loadCategories();
				loadDifficulties();
				loadStatsFromWebService();
				loadSettings(function() {
					
					var finishOpening = function() {
						submitUsageClick("/app/" + APP_VERSION + "/open");
						
						// Set the pause and resume callbacks
						document.addEventListener("pause", function() {
							submitUsageClick("/app/" + APP_VERSION + "/pause");
						}, false);
						document.addEventListener("resume", function() {
							submitUsageClick("/app/" + APP_VERSION + "/resume");
						}, false);
						
						applyTheme();
						loadTags(true, showReadyScreen);
						resetScores();
						loadScores();
					};
					
					// Send fresh install click if this is a fresh install
					// or upgrade click if this is an upgrade
					if (!sDataVersion) {
						submitUsageClick("/app/" + APP_VERSION + "/freshInstall");
						changeDataVersion(APP_VERSION);
						
						// For fresh installs, load starter tags into the database
						saveDifficultiesInLocalDatabase(starterDifficulties, function() {
							saveCategoriesInLocalDatabase(starterCategories, function() {
								saveTagsInLocalDatabase(starterPhrases, finishOpening);
							});
						});
					} else if (sDataVersion != APP_VERSION) {
						submitUsageClick("/app/" + APP_VERSION + "/upgrade");
						changeDataVersion(APP_VERSION);
						finishOpening();
					} else {
						finishOpening();
					}
				});
			}
		</script>
	</head>
	<body>
		<!-- Shows the splash screen image over the whole screen -->
		<img id="splashscreen" class="visible" src="images/splashscreen.png" />
	
		<!-- Invisible element that locks the UI -->
		<div id="uiLock"></div>
	
		<!-- Fades the background logo into the theme's background -->
		<div id="backgroundFader"></div>
		
		<!-- Shows a confetti animation when a winner is declared -->
		<div id="confetti"></div>
		
		<div id="main">
			<!-- App menu bar -->
			<header>
				<!-- TODO menu button should start with disabled icon -->
				<!-- TODO change the onclick, function should do nothing if button is disabled -->
				<a id="menuButton" class="header-button" href="#" onclick="menuButtonClick(); return false;">
					<img id="menuButtonIcon" class="header-button-icon" src="images/menu.png" alt="Menu" />
				</a>
				<!-- TODO: Change the onclick -->
				<a id="pauseButton" class="header-button" href="#" onclick="menuButtonClick(); return false;">
					<img id="pauseButtonIcon" class="header-button-icon" src="images/pause.png" alt="Pause" />
				</a>
				<a id="helpButton" class="header-button" href="#" onclick="helpButtonClick(); return false;">
					<img id="helpButtonIcon" class="header-button-icon" src="images/help.png" alt="Help" />
				</a>
				<a id="usedTagsButton" class="header-button" href="#" onclick="usedTagsButtonClick(); return false;">
					<img id="usedTagsButtonIcon" class="header-button-icon" src="images/usedTags.png" alt="List" />
				</a>
				<span id="app-name">
					<!-- Display the app name -->
					<script>document.write(APP_NAME);</script>
				</span>
			</header>
			
			<!-- Holds the score buttons -->
			<div id="scores"></div>
			
			<!-- Holds the current phrase, or game status messages -->
			<div id="tag"></div>
			
			<!-- Shows metadata for the current phrase -->
			<div id="tag-metadata"></div>
			
			<!-- Advances to the next phrase, or starts the game -->
			<a id="nextButton" href="#" onmouseup="nextButtonClick(); return false;">Next</a>
			
			<!-- The main menu, hidden by default -->
			<div id="mainMenu" class="hidden">
				<!-- Close button for the menu -->
				<div id="menuItemClose" class="menuItem">
					<img id="mainMenuCloseIcon" class="middle" src="images/delete.png" />
					<span class="menuItemName">Return to the game</span>
				</div>
				
				<div class="menuHeader">Features</div>
				<div id="menuItemCustomPhrases" class="menuItem">
					<span class="menuItemName">Custom phrases</span>
				</div>
				
				<!-- Holds the score menu items when a game is in progress -->
				<div id="scoreSettings"></div>
				
				<div class="menuHeader">Phrase Options</div>
				<div id="menuItemCategoryIds" class="menuItem">
					<span class="menuItemName">Categories</span>: <span class="menuItemValue"></span>
				</div>
				<div id="menuItemDifficulty" class="menuItem">
					<span class="menuItemName">Difficulty</span>: <select class="menuItemValue"></select>
				</div>
				<div id="menuItemMaxWords" class="menuItem">
					<button class="menuItemIncrease"></button>
					<button class="menuItemDecrease"></button>
					<span class="menuItemName">Max words per phrase</span>: <span class="menuItemValue"></span>
				</div>
				<!-- TODO: Left off here removing onclicks -->
				<div id="menuItemMaxCharacters" class="menuItem">
					<button class="menuItemIncrease" onclick="arguments[0].stopPropagation(); menuItemMaxCharactersIncrease();"></button>
					<button class="menuItemDecrease" onclick="arguments[0].stopPropagation(); menuItemMaxCharactersDecrease();"></button>
					<span class="menuItemName">Max characters per phrase</span>: <span class="menuItemValue"></span>
				</div>
				<!-- Label instead of div; wraps the checkbox it is "for" so that the whole row is clickable -->
				<label id="menuItemEdgy" class="menuItem" for="menuItemEdgyCheckBox" style="display: block;">
					<input id="menuItemEdgyCheckBox" type="checkbox" class="menuItemValue" onchange="menuItemEdgyChange();" />
					<span class="menuItemName">Include adult-only phrases</span>
				</label>
				<!-- Label instead of div; wraps the checkbox it is "for" so that the whole row is clickable -->
				<label id="menuItemShowCategory" class="menuItem" for="menuItemShowCategoryCheckBox" style="display: block;">
					<input id="menuItemShowCategoryCheckBox" type="checkbox" class="menuItemValue" onchange="menuItemShowCategoryChange();" />
					<span class="menuItemName">Show phrase categories</span>
				</label>
				
				<div class="menuHeader">Game Rules</div>
				<div id="menuItemWinningPoint" class="menuItem" onclick="menuItemWinningPointClick();">
					<button class="menuItemIncrease" onclick="arguments[0].stopPropagation(); menuItemWinningPointIncrease();"></button>
					<button class="menuItemDecrease" onclick="arguments[0].stopPropagation(); menuItemWinningPointDecrease();"></button>
					<span class="menuItemName">Points to win</span>: <span class="menuItemValue"></span>
				</div>
				<div id="menuItemNumberOfTeams" class="menuItem" onclick="menuItemNumberOfTeamsClick();">
					<button class="menuItemIncrease" onclick="arguments[0].stopPropagation(); menuItemNumberOfTeamsIncrease();"></button>
					<button class="menuItemDecrease" onclick="arguments[0].stopPropagation(); menuItemNumberOfTeamsDecrease();"></button>
					<span class="menuItemName">Number of teams</span>: <span class="menuItemValue"></span>
				</div>
				<div id="menuItemMinimumTime" class="menuItem" onclick="menuItemMinimumTimeClick();">
					<button class="menuItemIncrease" onclick="arguments[0].stopPropagation(); menuItemMinimumTimeIncrease();"></button>
					<button class="menuItemDecrease" onclick="arguments[0].stopPropagation(); menuItemMinimumTimeDecrease();"></button>
					<span class="menuItemName">Least possible game seconds</span>: <span class="menuItemValue"></span>
				</div>
				<div id="menuItemMaximumTime" class="menuItem" onclick="menuItemMaximumTimeClick();">
					<button class="menuItemIncrease" onclick="arguments[0].stopPropagation(); menuItemMaximumTimeIncrease();"></button>
					<button class="menuItemDecrease" onclick="arguments[0].stopPropagation(); menuItemMaximumTimeDecrease();"></button>
					<span class="menuItemName">Most possible game seconds</span>: <span class="menuItemValue"></span>
				</div>
				
				<div class="menuHeader">Effects</div>
				<div id="menuItemBeepSoundFile" class="menuItem">
					<span class="menuItemName">Timer tick</span>: <select class="menuItemValue" onchange="menuItemBeepSoundFileChange();">
						<option value="none">None</option>
						<option value="sounds/beep.wav">Beep</option>
						<option value="sounds/clap.wav">Clap</option>
						<option value="sounds/click.wav">Click</option>
						<option value="sounds/corkpop.wav">Cork pop</option>
						<option value="sounds/echo.wav">Echo</option>
						<option value="sounds/footstep.wav">Footstep</option>
						<option value="sounds/highbeep.wav">High beep</option>
						<option value="sounds/longbeep.wav">Long beep</option>
						<option value="sounds/lowbeep.wav">Low beep</option>
						<option value="sounds/malevoice.wav">Male voice</option>
						<option value="sounds/meow.wav">Meow</option>
						<option value="sounds/orchestra.wav">Orchestra</option>
						<option value="sounds/thump.wav">Thump</option>
						<option value="sounds/tick.wav">Tick</option>
					</select>
				</div>
				<div id="menuItemTheme" class="menuItem">
					<span class="menuItemName">Theme</span>: <select class="menuItemValue" onchange="menuItemThemeChange();">
						<option value="style/theme_light.css">Light</option>
						<option value="style/theme_dark.css">Dark</option>
					</select>
				</div>
				<!-- Label instead of div; wraps the checkbox it is "for" so that the whole row is clickable -->
				<label id="menuItemVibrate" class="menuItem" for="menuItemVibrateCheckBox" style="display: block;">
					<input id="menuItemVibrateCheckBox" type="checkbox" class="menuItemValue" onchange="menuItemVibrateChange();" />
					<span class="menuItemName">Vibrate</span>
				</label>
				
				<div class="menuHeader">Other</div>
				<div class="menuItem" onclick="menuItemHelpClick();"><span class="menuItemName">Help</span></div>
				<div id="menuItemAbout" class="menuItem" onclick="menuItemAboutClick();"><span class="menuItemName">About</span></div>
			</div>
		</div>
	</body>
</html>